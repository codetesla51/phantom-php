#!/bin/bash
# Function for automatic Phantom-PHP installation

# Color Variables
RED='\033[1;91m'
GREEN='\033[1;92m'
YELLOW='\033[1;93m'
BLUE='\033[1;94m'
NC='\033[0m'  # No Color

# Function to display a spinning loader
show_loader() {
    local delay=0.2
    local spin='/-\|'
    local i=0
    while kill -0 "$1" 2>/dev/null; do
        printf "\r${spin:i++%${#spin}:1} Loading..."
        sleep $delay
    done
    printf "\r"  # Clear the loader
}

(sleep 2) & 
dummy_pid=$!
show_loader "$dummy_pid"
wait "$dummy_pid" 

log() {
    local color="$1"
    shift
    echo -e "${color}$*${NC}"
}

# Installation function
phantomPhpInstall() {
    show_loader
    clear
    sleep 1
    echo -e "${GREEN}
           ▄▄▄▄▄▄▄▄▄▄▄▄
        ▄█▀▀▀▀▀▀▀▀▀▀▀▀▀█▄
      ▄█▀     ▄▄▄▄▄▄     ▀█▄
     ██     ██████████     ██
    ██      ██████████      ██
     ██     ██████████     ██
       ▀█▄    ▀████▀    ▄█▀
          ▀▀▀▄▄▄▄▄▄▄▀▀▀

         PhantomPHP Server
      Fast and Reliable.

         Made by Uthman Dev
    ${NC}"
    echo -e "\n"
    log "${BLUE}" "Checking Dependencies..."
    sleep 2

    log "${BLUE}" "\nChecking if PHP is installed..."
        sleep 1

    if command -v php >/dev/null 2>&1; then
        log "${GREEN}" "PHP is installed\n"
    else
        log "${RED}" "PHP is not installed"
        read -p "Do you want to install PHP? (y/n): " choice
        if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
            log "${YELLOW}" "Installing PHP..."
            pkg install php -y 
            until command -v php >/dev/null 2>&1; do
                sleep 2 
            done
            log "${GREEN}" "PHP installed successfully!\n"
        fi
    fi
    sleep 2

    log "${BLUE}" "Checking if MySQL is installed..."
        sleep 1

    if command -v mysql >/dev/null 2>&1; then
        log "${GREEN}" "MySQL is installed\n"
    else
        log "${RED}" "MySQL is not installed"
        read -p "Do you want to install MySQL? (y/n): " choice
        if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
            log "${YELLOW}" "Installing MySQL..."
            pkg install phpmyadmin 
            until command -v mysql >/dev/null 2>&1; do
                sleep 2
            done
            log "${GREEN}" "MySQL installed successfully!\n"
        fi
    fi
    sleep 2

    log "${BLUE}" "Checking if MariaDB is installed..."
        sleep 1

    if command -v mariadb >/dev/null 2>&1; then
        log "${GREEN}" "MariaDB is installed\n"
    else
        log "${RED}" "MariaDB is not installed"
        read -p "Do you want to install MariaDB? (y/n): " choice
        if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
            log "${YELLOW}" "Installing MariaDB..."
            pkg install mariadb -y 
            until command -v mariadb >/dev/null 2>&1; do
                sleep 2
            done
            log "${GREEN}" "MariaDB installed successfully!\n"
        fi
    fi

    log "${GREEN}" "Everything is installed. All set for Phantom-PHP!\n"
    sleep 1

    log "${YELLOW}" "Installing Phantom-PHP...\n"
  show_loader
    sleep 1

    log "${BLUE}" "Initializing 'serve' command...\n"
    sleep 2
   if [[ -f "serve" ]]; then
        log "${YELLOW}" "Moving 'serve' file to ~/bin/..."
        mv serve ~/bin/

        if [[ -f ~/bin/serve ]]; then
            if [[ ! -x ~/bin/serve ]]; then
                log "${YELLOW}" "Making 'serve' executable..."
                chmod +x ~/bin/serve

                if [[ -x ~/bin/serve ]]; then
                    log "${GREEN}" "'Serve' file is now executable."
                else
                    log "${RED}" "Error: Failed to set executable permissions on 'serve'."
                    return
                fi
            else
                log "${GREEN}" "'Serve' file is already executable."
            fi

            if ! grep -q 'export PATH="$HOME/bin:$PATH"' ~/.bashrc; then
                echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
                log "${YELLOW}" "Updating PATH in ~/.bashrc..."
            fi

            log "${YELLOW}" "Sourcing ~/.bashrc..."
            source ~/.bashrc
            log "${GREEN}" "'Serve' command setup done. Phantom-PHP installed successfully.\n"

            if serve -i; then
                log "${GREEN}" "'serve' command is now running."
            else
                log "${RED}" "Failed to run 'serve' command."
            fi
        else
            log "${RED}" "Error: Failed to move 'serve' to ~/bin/."
        fi
    else
        log "${RED}" "Error: 'serve' file not found. Please clone the repository again."
    fi

}


phantomPhpInstall
